{% extends "base.html" %}

{% block content %}
<div class="container">
    <span id="rpi" hidden></span>
    <table id="data-table">
        <thead>
            <tr>
                <th scope="col">Rpi</th>
                <th scope="col">Codigo</th>
                <th scope="col">Numero</th>
                <th scope="col">Nome codigo</th>
                <th scope="col">Razao social</th>
                <th scope="col">Procurador</th>
                <th scope="col">Email</th>
                <th scope="col">Insert email</th>
            </tr>
        </thead>
    </table>
</div>

<script name = guid>
    function guidGenerator() {
    var S4 = function() {
       return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
    };
    return String(S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
}
</script>
<script name = "datatables">
    var data = JSON.parse('{{desenho | tojson | safe}}')
    var table = $('#data-table').DataTable({});
    var span = $('#rpi').text(data.numero_rpi[0])

function dataAdd(){
    $.each(data.numero_do_pedido, function (i, key) {
        id_html = guidGenerator();
        table.row.add([
            data.numero_rpi[i],
            data.codigo[i],
            data.numero_do_pedido[i],
            data.nome_do_depositante[i],
            data.nome_do_autor[i],
            data.nome_do_procurador[i],
            data.email[i],
            `
            <form onclick="post_email('${id_html}')" id="${id_html}">
            <input name="email"><input type="hidden" value="${$('#rpi')[0].innerHTML}" name="rpi">
            <input type="hidden" value="${data.numero_do_pedido[i]}" name="num_ped">
            <button type="button" class="btn btn-primary">Inserir</button>
            </form>
            `
        ]);
    });

    table.draw();
};
dataAdd();
</script>
{% endblock %}
{% block ajax %}
<script name = "post_email">

    function getFormData(serialized){
        var unindexed_array = serialized.serializeArray();
        var indexed_array = {'rpi':$('#data-table tbody tr td')[0].innerHTML};

        $.map(unindexed_array, function(n, i){
            indexed_array[n['name']] = n['value'];
        });

        return indexed_array;
        }

    function post_email(id_html){
        var num_ped = $(`#${id_html}`);
        num_ped = getFormData(num_ped);
                  
        $.ajax({
        url: "/post_insert_email",
        type: "POST",
        data: JSON.stringify(num_ped),
        contentType: "application/json;charset=UTF-8",
        success: function(response) {
            table.clear();
            dataAdd();
        },
        error: function(xhr){
            console.log('error')
        }
        });
        return false

    }
</script>
{% endblock %}
    